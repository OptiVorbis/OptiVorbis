[package]
name = "optivorbis"
version.workspace = true
authors.workspace = true
edition.workspace = true
rust-version.workspace = true
description = "A lossless, format-preserving, two-pass Vorbis optimization and repair library"
documentation = "https://docs.rs/optivorbis"
readme = "../../README.md"
homepage.workspace = true
repository.workspace = true
license = "AGPL-3.0-or-later OR BSD-3-Clause"
keywords.workspace = true
categories.workspace = true
# Run cargo diet to maintain this include list
include = ["LICENSE", "LICENSE.BSD-3-Clause", "build.rs", "src/**/*"]

[package.metadata.docs.rs]
rustdoc-args = ["--cfg", "docsrs"]

# We set custom wasm-opt flags for two reasons:
# - First, since Rust 1.82, the wasm-opt version used by wasm_pack v0.13.1, v117,
#   is unable to recognize the new LLVM default of using bulk memory WASM extensions,
#   so we need to explicitly enable support for such extensions. See:
#   https://github.com/rustwasm/wasm-pack/issues/1441#issuecomment-2474250133
#   https://github.com/rust-lang/rust/issues/137315
# - Second, we want to optimize for size as much as possible, so we use the -Oz flag,
#   which is more aggressive than the default -O flag, equivalent to -Os.
[package.metadata.wasm-pack.profile]
release = { wasm-opt = [
  "-Oz",
  "--enable-bulk-memory",
  "--enable-nontrapping-float-to-int",
] }
profiling = { wasm-opt = [
  "-Oz",
  "--enable-bulk-memory",
  "--enable-nontrapping-float-to-int",
] }

[lib]
crate-type = ["cdylib", "lib"]

[dependencies]
bumpalo.workspace = true
console_log = { workspace = true, features = ["color"], optional = true }
getrandom.workspace = true
indexmap.workspace = true
log.workspace = true
ogg.workspace = true
ouroboros.workspace = true
rand_xoshiro.workspace = true
rlsf = { workspace = true, optional = true }
slice-group-by.workspace = true
thiserror.workspace = true
tinyvec.workspace = true
vorbis_bitpack.workspace = true
wasm-bindgen = { workspace = true, default-features = false, optional = true }
web-sys = { workspace = true, optional = true }

[dev-dependencies]
oggvorbismeta.workspace = true
test-log.workspace = true

[features]
default = ["source-date-epoch"]
source-date-epoch = []
wasm-bindings = ["dep:rlsf", "dep:wasm-bindgen"]
wasm-web-bindings = [
  "dep:console_log",
  "dep:web-sys",
  "getrandom/wasm_js",
  "wasm-bindings",
]
